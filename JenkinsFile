pipeline{
    agent any
    environment{
        IMAGE_NAME = 'cwvj-flask'
        REPOSITORY = 'vasanthdevops01'
        TAG = "${BUILD_NUMBER}"
    }
    stages{
        stage('Build'){
            steps{
                echo 'Building the application...'
                echo "Built image: $REPOSITORY/$IMAGE_NAME"
                sh 'docker build -t $REPOSITORY/$IMAGE_NAME:$TAG .'
            }
        }
        stage('Push Docker Image'){
            steps{
                echo 'Pushing Docker image to registry...'
                withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'DOCKERHUB_PWD', usernameVariable: 'DOCKERHUB_USER')]) {
                sh 'echo "$DOCKERHUB_PWD" | docker login -u "$DOCKERHUB_USER" --password-stdin'
                sh 'docker push "$REPOSITORY/$IMAGE_NAME:$TAG"'
                sh 'docker push "$REPOSITORY/$IMAGE_NAME:latest"'
                sh '''
                cat > deployment_artifact${TAG}.txt <<EOF
                build: $BUILD_NUMBER
                image: $REPOSITORY/$IMAGE_NAME:$TAG
                commit: $GIT_COMMIT
                branch: $GIT_BRANCH
                date: $(date +%Y-%m-%d_%H-%M-%S)
                url: $BUILD_URL
                EOF
                '''
                archiveArtifacts artifacts: "deployment_artifact{$TAG}.txt", fingerprint: true, followSymlinks: false
              }
            }
        }
        stage('Deploy'){
            steps{
                echo 'Deploying the application...'
                sh 'docker pull "$REPOSITORY/$IMAGE_NAME:latest"'
                sh 'docker rm -f docker-app || true'
                sh 'docker run  -d --name docker-app -p 5000:5000 "$REPOSITORY/$IMAGE_NAME:latest"'
            }
        }
        stage('Test'){
            steps{
                echo "Test your application at http://localhost:5000"
            }
       }
    }
    post{
        success{
            echo 'Pipeline completed successfully.'
        }
        failure{
            echo 'Pipeline failed. Please check the logs.'
        }
        always{
            echo 'Cleaning up workspace...'
            deleteDir()
        }
    }

}





